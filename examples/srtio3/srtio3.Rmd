---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: 3.7_env
    language: python
    name: python3
---

# $\rm{SrTiO}_3$ example
### In this example, we extract the self-energies and Eliashberg function from  
### a 2DEL in the $d_{xy}$ bands on the $\rm{TiO}_{2}$-terminated surface of $\rm{SrTiO}_3$.

```{python}
# %load_ext autoreload
# %autoreload 2

import xarpes
import matplotlib.pyplot as plt
import os

xarpes.plot_settings('default')
```

```{python}
script_dir = xarpes.set_script_dir()

dfld = 'data_sets' # Folder containing the data
flnm = 'STO_2_0010STO_2_' # Name of the file
extn = '.ibw' # Extension of the file

data_file_path = os.path.join(script_dir, dfld, flnm + extn)
```

```{python}
# %matplotlib inline

fig = plt.figure(figsize=(8, 5))
ax = fig.gca()

bmap = xarpes.BandMap(data_file_path, energy_resolution=0.01,
                      angle_resolution=0.2, temperature=20)

fig = bmap.plot(abscissa='angle', ordinate='kinetic_energy', ax=ax)
```

```{python}
# %matplotlib inline

fig = bmap.fit_fermi_edge(hnuminphi_guess=42.24, background_guess=1e4,
                          integrated_weight_guess=1e6, angle_min=-5,
                          angle_max=5, ekin_min=42.22, ekin_max=42.3,
                          show=True, title='Fermi edge fit')

print('The optimised h nu - Phi = ' + f'{bmap.hnuminphi:.4f}' + ' +/- '
      + f'{bmap.hnuminphi_std:.4f}' + ' eV.')
```

```{python}
# %matplotlib inline

angle_min = 0.6
angle_max = 4.8
en_val = 0.0

mdc = xarpes.MDCs(*bmap.mdc_set(angle_min, angle_max, energy_value=en_val))

fig = plt.figure(figsize=(6, 5))
ax = fig.gca()

fig = mdc.plot(ax=ax)
```

```{python}
import numpy as np

# %matplotlib inline

fig = plt.figure(figsize=(7, 5))
ax = fig.gca()

k_0 = 0.03
theta_0 = 0.6
dtor = np.pi / 180

guess_dists = xarpes.CreateDistributions([
xarpes.Constant(offset=600),

xarpes.SpectralLinear(amplitude=3000, peak=2.4, broadening=0.0001,
                      name='Faint_band', index='1'),

xarpes.SpectralQuadratic(amplitude=3800, peak=2.45, broadening=0.00024,
            center_wavevector=k_0, name='Inner_band', index='2'),

xarpes.SpectralQuadratic(amplitude=1800, peak=3.6, broadening=0.0004,
            center_wavevector=k_0, name='Outer_band', index='3')
])

mat_el = lambda x: np.sin((x - theta_0) * dtor) ** 2

# mat_el = lambda x, theta_0: np.sin((x - theta_0) * dtor) ** 2

mat_args = {
#  'theta_0' : 0.6
}

fig = mdc.visualize_guess(distributions=guess_dists, matrix_element=mat_el,
                           ax=ax, matrix_args=mat_args, show=True)
```

```{python}
# %matplotlib inline

fig = plt.figure(figsize=(7, 5))
ax = fig.gca()

fig, new_dists, covariance_matrix, new_mat_args = mdc.fit(
    distributions=guess_dists, matrix_element=mat_el, matrix_args=mat_args,
    ax=ax, show=True)
```

```{python}
# %matplotlib widget

energy_range = [-0.2, 0.01]

angle_min = 0.6
angle_max = 4.8

mdc = xarpes.MDCs(*bmap.mdc_set(angle_min, angle_max, energy_range=energy_range))

fig = plt.figure(figsize=(8, 5))
ax = fig.gca()

# mdc.plot(angle_range=mdc.angles, angle_resolution=0.2, ax=ax, show=False,
#            fig_close=False)

fig = mdc.plot(ax=ax)
```

```{python}
# %matplotlib inline

fig = plt.figure(figsize=(7, 5))
ax = fig.gca()

fig, new_dists, covariance_matrix, new_mat_args = mdc.fit(
    distributions=guess_dists, matrix_element=mat_el, matrix_args=mat_args,
    energy_value=0, ax=ax, show=True)

```
